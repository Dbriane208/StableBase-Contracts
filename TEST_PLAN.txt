# StableBase Contracts - Comprehensive Test Plan
**Generated: December 3, 2025**

## UNIT TESTS

### 1. PaymentProcessorTest.t.sol - CRITICAL PRIORITY

#### A. INITIALIZATION TESTS
- testInitialize() - Basic initialization with valid parameters
- testInitializeRevertsWithZeroPlatformWallet() - Zero address validation
- testInitializeRevertsWithInvalidFeeBps() - Fee validation (> maxBps)
- testInitializeRevertsWithZeroMerchantRegistry() - Registry address validation
- testInitializeRevertsWithZeroOrderExpiration() - Expiration time validation
- testInitializeRevertsWithInvalidMaxSlippage() - Slippage validation (> maxBps)
- testInitializeRevertsWhenAlreadyInitialized() - Double initialization prevention

#### B. ORDER CREATION TESTS
- testCreateOrderSuccess() - Valid order creation
- testCreateOrderEmitsEvent() - Verify OrderCreated event emission
- testCreateOrderGeneratesUniqueId() - Order ID uniqueness
- testCreateOrderRevertsWithUnsupportedToken() - Token support validation
- testCreateOrderRevertsWithZeroAmount() - Amount validation
- testCreateOrderRevertsWithInvalidMetadata() - Metadata URI validation
- testCreateOrderRevertsWithUnregisteredMerchant() - Merchant validation
- testCreateOrderRevertsWhenPaused() - Pause state validation
- testCreateOrderRevertsWithInsufficientBalance() - Balance validation
- testCreateOrderSetsCorrectInitialStatus() - Status = CREATED
- testCreateOrderStoresCorrectOrderData() - All order fields validation

#### C. PAYMENT TESTS
- testPayOrderSuccess() - Valid payment processing
- testPayOrderEmitsEvent() - Verify OrderPaid event emission
- testPayOrderUpdatesStatus() - Status CREATED -> PAID
- testPayOrderTransfersTokensToContract() - Token transfer validation
- testPayOrderRevertsWithNonExistentOrder() - Order existence check
- testPayOrderRevertsWithWrongStatus() - Status validation (only CREATED)
- testPayOrderRevertsWhenPaused() - Pause state validation
- testPayOrderRevertsWithExpiredOrder() - Order expiration validation
- testPayOrderRevertsWithInsufficientBalance() - Payer balance validation
- testPayOrderRevertsWithInsufficientAllowance() - Token allowance validation

#### D. SETTLEMENT TESTS
- testSettleOrderByMerchant() - Merchant settlement authorization
- testSettleOrderByOwner() - Owner settlement authorization
- testSettleOrderEmitsEvent() - Verify OrderSettled event emission
- testSettleOrderUpdatesStatus() - Status PAID -> SETTLED
- testSettleOrderCalculatesCorrectFees() - Fee calculation validation
- testSettleOrderTransfersToMerchant() - Merchant payout validation
- testSettleOrderTransfersToPlatform() - Platform fee validation
- testSettleOrderWithTokenSpecificFees() - Token-specific fee override
- testSettleOrderWithDefaultFees() - Default fee application
- testSettleOrderRevertsWithNonExistentOrder() - Order existence check
- testSettleOrderRevertsWithWrongStatus() - Status validation (only PAID)
- testSettleOrderRevertsWithUnauthorizedCaller() - Authorization validation
- testSettleOrderRevertsWhenPaused() - Pause state validation

#### E. REFUND TESTS
- testRefundOrderByMerchant() - Merchant refund authorization
- testRefundOrderByOwner() - Owner refund authorization
- testRefundOrderEmitsEvent() - Verify OrderRefunded event emission
- testRefundOrderUpdatesStatus() - Status PAID -> REFUNDED
- testRefundOrderTransfersBackToPayer() - Full amount return validation
- testRefundOrderRevertsWithNonExistentOrder() - Order existence check
- testRefundOrderRevertsWithWrongStatus() - Status validation (only PAID)
- testRefundOrderRevertsWithUnauthorizedCaller() - Authorization validation
- testRefundOrderRevertsWhenPaused() - Pause state validation

#### F. CANCELLATION TESTS
- testCancelOrderByMerchant() - Merchant cancellation authorization
- testCancelOrderByOwner() - Owner cancellation authorization
- testCancelOrderEmitsEvent() - Verify OrderCancelled event emission
- testCancelOrderUpdatesStatus() - Status CREATED -> CANCELLED
- testCancelOrderRevertsWithNonExistentOrder() - Order existence check
- testCancelOrderRevertsWithWrongStatus() - Status validation (only CREATED)
- testCancelOrderRevertsWithUnauthorizedCaller() - Authorization validation
- testCancelOrderRevertsWhenPaused() - Pause state validation

#### G. BATCH OPERATIONS TESTS
- testBatchCancelOrdersSuccess() - Multiple order cancellation
- testBatchCancelOrdersEmitsEvents() - Event emission for each order
- testBatchCancelOrdersPartialSuccess() - Handle mixed valid/invalid orders
- testBatchCancelOrdersRevertsWhenPaused() - Pause state validation
- testBatchCancelOrdersRevertsWithUnauthorizedCaller() - Authorization validation

#### H. ADMIN FUNCTION TESTS
- testUpdateMerchantRegistry() - Registry address update
- testUpdateMerchantRegistryRevertsWithZeroAddress() - Zero address validation
- testUpdateMerchantRegistryRevertsWhenNotOwner() - Owner-only validation
- testUpdateDefaultPlatformFeeBps() - Default fee update
- testUpdateDefaultPlatformFeeBpsRevertsWithInvalidBps() - Fee validation
- testUpdateDefaultPlatformFeeBpsRevertsWhenNotOwner() - Owner-only validation
- testSetTokenSupport() - Token support status update
- testSetTokenSupportRevertsWhenNotOwner() - Owner-only validation
- testUpdateProtocolAddress() - Platform wallet update
- testUpdateProtocolAddressRevertsWhenNotOwner() - Owner-only validation
- testSetTokenFeeSettings() - Token-specific fee configuration
- testSetTokenFeeSettingsRevertsWithInvalidBps() - Fee validation
- testSetTokenFeeSettingsRevertsWhenNotOwner() - Owner-only validation
- testUpdateOrderExpirationTime() - Expiration time update
- testUpdateOrderExpirationTimeRevertsWithZero() - Zero validation
- testUpdateOrderExpirationTimeRevertsWhenNotOwner() - Owner-only validation
- testUpdateMaxSlippageBps() - Slippage limit update
- testUpdateMaxSlippageBpsRevertsWithInvalidBps() - Slippage validation
- testUpdateMaxSlippageBpsRevertsWhenNotOwner() - Owner-only validation

#### I. EMERGENCY FUNCTION TESTS
- testSetEmergencyWithdrawalEnabled() - Emergency flag toggle
- testSetEmergencyWithdrawalEnabledRevertsWhenNotOwner() - Owner-only validation
- testEmergencyWithdrawSuccess() - Emergency token withdrawal
- testEmergencyWithdrawRevertsWhenDisabled() - Enabled flag validation
- testEmergencyWithdrawRevertsWhenNotOwner() - Owner-only validation
- testEmergencyWithdrawRevertsWithZeroAddress() - Address validation
- testEmergencyWithdrawRevertsWithInsufficientBalance() - Balance validation

#### J. PAUSE/UNPAUSE TESTS
- testPauseSuccess() - Contract pausing
- testPauseRevertsWhenNotOwner() - Owner-only validation
- testUnpauseSuccess() - Contract unpausing
- testUnpauseRevertsWhenNotOwner() - Owner-only validation
- testFunctionsRevertWhenPaused() - All external functions respect pause

#### K. VIEW FUNCTION TESTS
- testGetOrderReturnsCorrectData() - Order data retrieval
- testGetOrderRevertsWithNonExistentOrder() - Non-existent order handling
- testGetOrderStatusReturnsCorrectStatus() - Status retrieval
- testGetOrderStatusRevertsWithNonExistentOrder() - Non-existent order handling
- testIsTokenSupportedReturnsCorrectStatus() - Token support check
- testGetMerchantTokenBalance() - Balance calculation for merchants
- testGetPlatformTokenBalance() - Balance calculation for platform

#### L. REENTRANCY TESTS
- testCreateOrderPreventsReentrancy() - Reentrancy protection
- testPayOrderPreventsReentrancy() - Reentrancy protection
- testSettleOrderPreventsReentrancy() - Reentrancy protection
- testRefundOrderPreventsReentrancy() - Reentrancy protection

#### M. FEE CALCULATION TESTS
- testFeeCalculationWithDefaultFees() - Default fee application
- testFeeCalculationWithTokenSpecificFees() - Token override behavior
- testFeeCalculationWithZeroFees() - Zero fee handling
- testFeeCalculationWithMaxFees() - Maximum fee handling
- testFeeDistributionAccuracy() - Merchant vs platform split validation

### 2. TokensManagerTest.t.sol - HIGH PRIORITY

#### A. INITIALIZATION TESTS
- testTokensManagerInitSuccess() - Valid initialization
- testTokensManagerInitRevertsWithZeroAddress() - Zero address validation
- testTokensManagerInitRevertsWithInvalidMaxBps() - Max BPS validation

#### B. TOKEN SUPPORT TESTS
- testSetTokenSupportEnablesToken() - Token enabling
- testSetTokenSupportDisablesToken() - Token disabling
- testSetTokenSupportEmitsEvent() - Event emission validation
- testSetTokenSupportRevertsWithZeroAddress() - Address validation
- testIsTokenSupportedReturnsCorrectStatus() - Support status check

#### C. FEE SETTINGS TESTS
- testSetTokenFeeSettingsSuccess() - Fee configuration
- testSetTokenFeeSettingsEmitsEvent() - Event emission validation
- testSetTokenFeeSettingsRevertsWithInvalidBps() - BPS validation
- testGetTokenFeeSettingsReturnsCorrectData() - Fee retrieval
- testTokenPlatformFeeBpsWithSpecificFee() - Token-specific fee return
- testTokenPlatformFeeBpsWithDefaultFee() - Default fee fallback

#### D. PROTOCOL ADDRESS TESTS
- testUpdateProtocolAddressSuccess() - Platform wallet update
- testUpdateProtocolAddressEmitsEvent() - Event emission validation
- testUpdateProtocolAddressRevertsWithZeroAddress() - Address validation
- testGetPlatformWalletReturnsCorrectAddress() - Wallet retrieval

### 3. MerchantRegistryTest.t.sol - ALREADY COMPLETE ✅
**Current Status: 6/6 tests passing (100% success rate)**
**Note: This serves as the template for other test files**

## INTEGRATION TESTS

### 4. StableBaseIntegrationTest.t.sol - CRITICAL PRIORITY

#### A. FULL PAYMENT FLOW TESTS
- testCompletePaymentFlowSuccess() - Register merchant → Create order → Pay → Settle
- testCompletePaymentFlowWithTokenSpecificFees() - End-to-end with custom fees
- testCompletePaymentFlowWithMultipleTokens() - Multiple token support
- testCompleteRefundFlow() - Register merchant → Create order → Pay → Refund
- testCompleteCancellationFlow() - Register merchant → Create order → Cancel

#### B. CROSS-CONTRACT INTERACTION TESTS
- testMerchantRegistrationBeforeOrderCreation() - Registry integration
- testUnregisteredMerchantOrderCreationFails() - Registry validation
- testMerchantUpdateAffectsExistingOrders() - State consistency
- testMerchantVerificationAffectsPayments() - Verification status impact

#### C. TOKEN MANAGEMENT INTEGRATION TESTS
- testTokenSupportChangesDuringOrderLifecycle() - Dynamic token management
- testFeeSettingsUpdateAffectsNewOrders() - Fee configuration impact
- testFeeSettingsDoNotAffectExistingOrders() - State immutability
- testMultipleTokenPaymentsWithDifferentFees() - Complex fee scenarios

#### D. EVENT INTEGRATION TESTS
- testEventEmissionAcrossContracts() - Cross-contract event verification
- testEventSequenceInCompleteFlow() - Correct event ordering
- testEventDataConsistencyAcrossContracts() - Data integrity validation

#### E. AUTHORIZATION INTEGRATION TESTS
- testMerchantSettlementAuthorization() - Cross-contract auth
- testOwnerOverrideCapabilities() - Owner privileges across contracts
- testUnauthorizedOperationsFailAcrossContracts() - Security boundaries

### 5. SecurityTest.t.sol - HIGH PRIORITY

#### A. REENTRANCY ATTACK TESTS
- testReentrancyAttackOnPayOrder() - Malicious token contract
- testReentrancyAttackOnSettleOrder() - Malicious merchant contract
- testReentrancyAttackOnRefundOrder() - Malicious refund recipient
- testReentrancyProtectionAcrossAllFunctions() - Comprehensive coverage

#### B. AUTHORIZATION ATTACK TESTS
- testUnauthorizedSettlementAttempts() - Settlement privilege escalation
- testUnauthorizedRefundAttempts() - Refund privilege escalation
- testUnauthorizedCancellationAttempts() - Cancellation privilege escalation
- testUnauthorizedAdminFunctionCalls() - Admin privilege validation

#### C. ECONOMIC ATTACK TESTS
- testFeeManipulationAttempts() - Fee calculation tampering
- testSlippageExploitationAttempts() - Slippage protection validation
- testTokenBalanceManipulation() - Balance calculation attacks
- testOrderExploitationAttempts() - Order state manipulation

#### D. EDGE CASE SECURITY TESTS
- testZeroAmountOrderHandling() - Zero value edge cases
- testMaximumValueOrderHandling() - Overflow protection
- testInvalidTokenAddressHandling() - Address validation
- testContractSelfDestructionResistance() - Destruction protection

### 6. UpgradeTest.t.sol - MEDIUM PRIORITY

#### A. PROXY UPGRADE TESTS
- testPaymentProcessorUpgrade() - Contract upgrade functionality
- testMerchantRegistryUpgrade() - Registry upgrade functionality
- testUpgradePreservesState() - State preservation validation
- testUpgradePreservesBalances() - Balance preservation validation

#### B. STORAGE LAYOUT TESTS
- testStorageLayoutCompatibility() - Storage slot validation
- testGapUtilization() - Upgrade gap usage
- testStateConsistencyAfterUpgrade() - Data integrity post-upgrade

#### C. INITIALIZATION AFTER UPGRADE TESTS
- testReinitializationPrevention() - Double initialization protection
- testNewFunctionalityAfterUpgrade() - New feature integration
- testBackwardCompatibilityAfterUpgrade() - Existing functionality preservation

### 7. GasOptimizationTest.t.sol - LOW PRIORITY

#### A. GAS USAGE BENCHMARKS
- testCreateOrderGasUsage() - Order creation efficiency
- testPayOrderGasUsage() - Payment processing efficiency
- testSettleOrderGasUsage() - Settlement processing efficiency
- testBatchOperationsGasEfficiency() - Batch vs individual operations

#### B. OPTIMIZATION VALIDATION TESTS
- testStorageAccessOptimization() - Storage read/write efficiency
- testEventEmissionEfficiency() - Event gas costs
- testFeeCalculationEfficiency() - Mathematical operation costs

## MOCK CONTRACTS NEEDED

### ERC20Mock.sol - ✅ ALREADY EXISTS
**Location: src/mocks/ERC20Mock.sol**

### Additional Mocks Required:
- **MaliciousERC20.sol** - For reentrancy testing
- **RevertingERC20.sol** - For transfer failure testing  
- **HighDecimalERC20.sol** - For precision testing
- **ZeroDecimalERC20.sol** - For edge case testing

## TESTING UTILITIES NEEDED

### Test Helpers:
- **PaymentTestHelpers.sol** - Common setup and utility functions
- **EventTestHelpers.sol** - Event emission verification utilities
- **MathTestHelpers.sol** - Fee calculation verification utilities
- **TimeTestHelpers.sol** - Timestamp and expiration testing utilities

### Test Data:
- **TestConstants.sol** - Common test values and addresses
- **TestScenarios.sol** - Complex multi-step test scenarios

## TEST EXECUTION PRIORITY

### Phase 1: CRITICAL (Week 1)
1. PaymentProcessorTest.t.sol - Core functionality
2. StableBaseIntegrationTest.t.sol - End-to-end flows
3. SecurityTest.t.sol - Basic security validation

### Phase 2: HIGH (Week 2)
1. TokensManagerTest.t.sol - Token management
2. Advanced SecurityTest.t.sol scenarios
3. Cross-contract edge cases

### Phase 3: MEDIUM (Week 3)
1. UpgradeTest.t.sol - Upgrade functionality
2. Advanced integration scenarios
3. Error condition coverage

### Phase 4: LOW (Week 4)
1. GasOptimizationTest.t.sol - Performance
2. Edge case coverage
3. Documentation and cleanup

## COVERAGE TARGETS

### Minimum Coverage Goals:
- **PaymentProcessor.sol**: 95% line coverage, 90% branch coverage
- **TokensManager.sol**: 90% line coverage, 85% branch coverage
- **Integration Tests**: 100% critical path coverage
- **Security Tests**: 100% attack vector coverage

### Success Criteria:
- All tests pass consistently
- No compilation warnings
- Gas usage within acceptable limits
- Security vulnerabilities identified and addressed
- Upgrade mechanisms validated
- Production deployment readiness achieved

---

**TOTAL ESTIMATED TESTS: ~150-200 individual test functions**
**ESTIMATED IMPLEMENTATION TIME: 3-4 weeks**
**CRITICAL DEPENDENCIES: ERC20Mock (✅), MerchantRegistry tests (✅)**